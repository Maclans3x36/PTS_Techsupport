name: PTS Progress Notification
on:
  issues:
    types: [labeled]

jobs:
  notify:
    # Only run if the label is "In-Progress" or "Completed"
    if: contains(fromJSON('["In-Progress", "Completed"]'), github.event.label.name)
    runs-on: ubuntu-latest
    steps:
      - name: Extract Email from Issue Body
        id: get_email
        run: |
          # This looks for any text formatted like an email in the issue description
          EMAIL=$(echo "${{ github.event.issue.body }}" | grep -oE '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}')
          echo "staff_email=$EMAIL" >> $GITHUB_OUTPUT

      - name: Send Progress Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{secrets.MAIL_USERNAME}}
          password: ${{secrets.MAIL_PASSWORD}}
          subject: "PTS Update: Issue is now ${{ github.event.label.name }}"
          to: ${{ steps.get_email.outputs.staff_email }}
          from: PTS Monitoring System
          body: |
            Hello,

            The technical issue you reported has been updated.
            
            Current Status: ${{ github.event.label.name }}
            TSE Assigned: ${{ github.event.issue.user.login }}
            
            You can track further updates here: ${{ github.event.issue.html_url }}
